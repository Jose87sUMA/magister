const express = require('express');
const bodyParser = require('body-parser');
const fs = require('fs');
const Groq = require("groq-sdk");

/**
 * Initialize Groq SDK with API key and browser settings
 */
const groq = new Groq({
    apiKey: "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",
    dangerouslyAllowBrowser: true
});

const app = express();
const port = 3030;

app.use(bodyParser.json());

/**
 * POST endpoint for generating a course
 * @param {Object} req - The request object
 * @param {Object} res - The response object
 */
app.post('/generar-curso', async (req, res) => {
    const { topic, experience, intensity } = req.body;
    if (!topic || !experience || !intensity) {
        return res.status(400).send('Missing parameters: topic, experience, and intensity are required.');
    }

    try {
        const newCourse = await generateCourse(topic, experience, intensity);
        return res.status(200).send(newCourse)
    } catch (error) {
        console.error('Error generating course:', error);
        res.status(500).send('Error generating course');
    }
});


/**
 * Function to generate a course
 * @param {string} topic - The topic of the course
 * @param {string} experience - The experience level of the course
 * @param {string} intensity - The intensity of the course
 * @returns {Promise<string>} The generated course
 */
const generateCourse = async (topic, experience, intensity) => {
    const prompt = generateCoursePrompt(topic, experience, intensity);
    const chatCompletion = await getGroqChatCompletion(prompt);
    return chatCompletion;
};

/**
 * Function to get chat completion from Groq
 * @param {string} prompt - The prompt for the chat
 * @returns {Promise<string>} The chat completion
 */
const getGroqChatCompletion = async (prompt) => {
    const chatCompletion = await groq.chat.completions.create({
        "messages": [
            {
                "role": "system",
                "content": "You must respond with a JSON format and do not include anything outside the JSON.\n\nYou must follow this structure:\n  {\n    \"id\": 4,\n    \"visible\": false,\n    \"title\": \"Curso de Ciencias para Escuela Primaria\",\n    \"description\": \"Este curso introductorio de ciencias está diseñado para estudiantes de primaria que deseen explorar conceptos básicos de ciencia de manera divertida y educativa. Desde el mundo natural hasta los fundamentos de la física y la química, este curso proporciona una introducción completa a través de actividades interactivas y experiencias prácticas.\",\n    \"completionPercentage\": 0,\n    \"stages\": [\n      {\n        \"id\": 1,\n        \"title\": \"El Mundo Natural\",\n        \"description\": \"Descubre la diversidad del mundo natural y aprende sobre los seres vivos y su entorno.\",\n        \"content\": \"El mundo natural está lleno de fascinantes criaturas y fenómenos. En esta etapa, exploraremos la biodiversidad de la Tierra, desde los diferentes tipos de ecosistemas hasta la variedad de formas de vida que los habitan. Aprenderemos sobre la importancia de la conservación y cómo podemos cuidar nuestro entorno.\\n\\nAdemás, nos sumergiremos en el ciclo de vida de las plantas y los animales, explorando conceptos como la germinación, la fotosíntesis y la reproducción. Descubriremos cómo las adaptaciones permiten a los organismos sobrevivir en sus hábitats y cómo los seres humanos impactan en los ecosistemas.\\n\\nAl final de esta etapa, tendrás una comprensión sólida del mundo natural que te rodea.\",\n        \"completed\": false,\n        \"testScore\": 0,\n        \"questions\": [\n          {\n            \"question\": \"¿Qué es la biodiversidad?\",\n            \"answers\": [\n              \"La variedad de vida en la Tierra\",\n              \"El estudio de los seres vivos\",\n              \"Un tipo de ecosistema\",\n              \"La cantidad de plantas en un área específica\"\n            ],\n            \"correctAnswer\": 0\n          },\n          {\n            \"question\": \"¿Qué proceso permite a las plantas producir su propio alimento?\",\n            \"answers\": [\n              \"Germinación\",\n              \"Fotosíntesis\",\n              \"Reproducción\",\n              \"Evolución\"\n            ],\n            \"correctAnswer\": 1\n          },\n          {\n            \"question\": \"¿Qué son las adaptaciones en los seres vivos?\",\n            \"answers\": [\n              \"Cambios físicos que ocurren durante la vida\",\n              \"Características heredadas que ayudan a la supervivencia\",\n              \"Transformaciones químicas en el cuerpo\",\n              \"Variaciones estacionales en el comportamiento\"\n            ],\n            \"correctAnswer\": 1\n          },\n          {\n            \"question\": \"¿Por qué es importante la conservación del medio ambiente?\",\n            \"answers\": [\n              \"Para proteger la diversidad de la vida\",\n              \"Para controlar el clima\",\n              \"Para aumentar la urbanización\",\n              \"Para reducir la biodiversidad\"\n            ],\n            \"correctAnswer\": 0\n          },\n          {\n            \"question\": \"¿Cuál es un ejemplo de un ecosistema acuático?\",\n            \"answers\": [\n              \"Bosque tropical\",\n              \"Desierto\",\n              \"Océano\",\n              \"Pradera\"\n            ],\n            \"correctAnswer\": 2\n          }\n        ]\n      },\n      {\n        \"id\": 2,\n        \"title\": \"Los Fundamentos de la Física\",\n        \"description\": \"Explora los principios básicos de la física y descubre cómo se aplican en la vida cotidiana.\",\n        \"content\": \"La física es la ciencia que estudia las propiedades y el comportamiento de la materia y la energía. En esta etapa, nos sumergiremos en los conceptos fundamentales de la física y su aplicación en nuestro entorno.\\n\\nComenzaremos explorando el movimiento y la fuerza, aprendiendo sobre la gravedad, la fricción y las leyes del movimiento de Newton. Descubriremos cómo se relacionan la masa y la velocidad en el movimiento de los objetos y cómo estas leyes se aplican en nuestra vida diaria, desde el lanzamiento de un balón hasta el movimiento de los planetas en el espacio.\\n\\nAdemás, exploraremos los conceptos de energía y trabajo, comprendiendo cómo se transfieren y se transforman en diferentes formas. Desde la energía cinética hasta la energía potencial, entenderemos cómo se relacionan estos conceptos con la actividad humana y el funcionamiento de las máquinas simples.\\n\\nAl final de esta etapa, tendrás una comprensión sólida de los principios básicos de la física y su aplicación en el mundo que te rodea.\",\n        \"completed\": false,\n        \"testScore\": 0,\n        \"questions\": [\n          {\n            \"question\": \"¿Cuál de las siguientes es una ley del movimiento de Newton?\",\n            \"answers\": [\n              \"Un objeto en reposo permanece en reposo a menos que actúe sobre él una fuerza externa\",\n              \"La velocidad de un objeto es constante a menos que actúe sobre él una fuerza neta\",\n              \"Por cada acción hay una reacción igual y opuesta\",\n              \"La fuerza neta que actúa sobre un objeto es igual a la masa del objeto por su aceleración\"\n            ],\n            \"correctAnswer\": 2\n          },\n          {\n            \"question\": \"¿Qué tipo de energía posee un objeto en movimiento?\",\n            \"answers\": [\n              \"Energía térmica\",\n              \"Energía eléctrica\",\n              \"Energía cinética\",\n              \"Energía potencial\"\n            ],\n            \"correctAnswer\": 2\n          },\n          {\n            \"question\": \"¿Qué es el trabajo en términos de física?\",\n            \"answers\": [\n              \"Cualquier esfuerzo físico realizado por una persona\",\n              \"La cantidad de energía necesaria para realizar una tarea\",\n              \"La fuerza aplicada a un objeto para moverlo a una distancia\",\n              \"La cantidad de movimiento de un objeto\"\n            ],\n            \"correctAnswer\": 1\n          },\n          {\n            \"question\": \"¿Qué causa la fricción entre dos superficies?\",\n            \"answers\": [\n              \"La gravedad\",\n              \"La magnetización\",\n              \"El contacto físico\",\n              \"La transferencia de energía\"\n            ],\n            \"correctAnswer\": 2\n          },\n          {\n            \"question\": \"¿Cuál es una forma de energía potencial?\",\n            \"answers\": [\n              \"Energía térmica\",\n              \"Energía cinética\",\n              \"Energía eléctrica\",\n              \"Energía gravitacional\"\n            ],\n            \"correctAnswer\": 3\n          }\n        ]\n      },\n      {\n        \"id\": 3,\n        \"title\": \"La Química en Nuestra Vida\",\n        \"description\": \"Descubre cómo la química está presente en nuestro día a día y cómo afecta nuestras vidas.\",\n        \"content\": \"La química es la ciencia que estudia la composición, estructura y propiedades de la materia, así como los cambios que experimenta durante las reacciones químicas. En esta etapa, exploraremos la importancia de la química en nuestra vida cotidiana y cómo influye en diversos aspectos, desde la alimentación hasta la medicina.\\n\\nComenzaremos aprendiendo sobre los elementos y los compuestos, entendiendo la diferencia entre átomos y moléculas y cómo se combinan para formar diferentes sustancias. Exploraremos los conceptos de la tabla periódica y cómo los elementos se clasifican según sus propiedades.\\n\\nAdemás, nos sumergiremos en el mundo de las reacciones químicas, comprendiendo cómo se producen los cambios químicos y qué factores los afectan. Desde la oxidación hasta la fermentación, exploraremos ejemplos de reacciones químicas en la naturaleza y en la industria.\\n\\nAl final de esta etapa, tendrás una comprensión sólida de cómo la química influye en nuestra vida diaria y cómo puedes aplicar estos conocimientos en tu propio entorno.\",\n        \"completed\": false,\n        \"testScore\": 0,\n        \"questions\": [\n          {\n            \"question\": \"¿Cuál es la unidad básica de un elemento químico?\",\n            \"answers\": [\n              \"Molécula\",\n              \"Átomo\",\n              \"Compuesto\",\n              \"Ion\"\n            ],\n            \"correctAnswer\": 1\n          },\n          {\n            \"question\": \"¿Qué tipo de sustancia se forma cuando dos o más elementos se combinan en proporciones fijas?\",\n            \"answers\": [\n              \"Elemento\",\n              \"Compuesto\",\n              \"Molécula\",\n              \"Átomo\"\n            ],\n            \"correctAnswer\": 1\n          },\n          {\n            \"question\": \"¿Qué es una reacción química?\",\n            \"answers\": [\n              \"Un cambio físico reversible\",\n              \"Una transformación de energía\",\n              \"Un cambio químico irreversible\",\n              \"Una interacción gravitacional\"\n            ],\n            \"correctAnswer\": 2\n          },\n          {\n            \"question\": \"¿Qué tipo de reacción química implica la combinación de oxígeno con otra sustancia?\",\n            \"answers\": [\n              \"Reducción\",\n              \"Oxidación\",\n              \"Fermentación\",\n              \"Descomposición\"\n            ],\n            \"correctAnswer\": 1\n          },\n          {\n            \"question\": \"¿Qué elemento químico es el componente principal del agua?\",\n            \"answers\": [\n              \"Hidrógeno\",\n              \"Oxígeno\",\n              \"Carbono\",\n              \"Nitrógeno\"\n            ],\n            \"correctAnswer\": 1\n          }\n        ]\n      },\n      {\n        \"id\": 4,\n        \"title\": \"El Universo y Más Allá\",\n        \"description\": \"Explora los misterios del universo, desde los planetas y las estrellas hasta los fenómenos cósmicos.\",\n        \"content\": \"El universo es vasto y lleno de maravillas que desafían nuestra comprensión. En esta etapa, nos aventuraremos en el cosmos para explorar los planetas, las estrellas y los fenómenos celestes que llenan el cielo nocturno.\\n\\nComenzaremos aprendiendo sobre nuestro propio sistema solar, desde el ardiente sol hasta los distantes planetas y lunas que lo orbitan. Descubriremos cómo se formaron los planetas y cómo la gravedad gobierna su movimiento.\\n\\nAdemás, exploraremos las estrellas y las galaxias, comprendiendo cómo nacen, viven y mueren las estrellas y cómo se forman las vastas estructuras que pueblan el universo. Aprenderemos sobre los agujeros negros, las nebulosas y otros objetos celestes fascinantes.\\n\\nAl final de esta etapa, tendrás una comprensión sólida del cosmos y de nuestra posición en él, así como de los misterios que todavía esperan ser descubiertos.\",\n        \"completed\": false,\n        \"testScore\": 0,\n        \"questions\": [\n          {\n            \"question\": \"¿Cuál es la estrella más cercana a la Tierra?\",\n            \"answers\": [\n              \"Vega\",\n              \"Sirio\",\n              \"El Sol\",\n              \"Alfa Centauri\"\n            ],\n            \"correctAnswer\": 2\n          },\n          {\n            \"question\": \"¿Cuál es la galaxia en la que se encuentra nuestro sistema solar?\",\n            \"answers\": [\n              \"Vía Láctea\",\n              \"Andrómeda\",\n              \"Centauro A\",\n              \"Sombrero\"\n            ],\n            \"correctAnswer\": 0\n          },\n          {\n            \"question\": \"¿Qué es un agujero negro?\",\n            \"answers\": [\n              \"Una estrella joven en formación\",\n              \"Un remanente estelar después de una explosión\",\n              \"Una región del espacio con una gravedad extrema\",\n              \"Una galaxia enana\"\n            ],\n            \"correctAnswer\": 2\n          },\n          {\n            \"question\": \"¿Cuál es el nombre de la misión espacial que llevó al primer hombre a la luna?\",\n            \"answers\": [\n              \"Apolo 11\",\n              \"Mercurio 7\",\n              \"Géminis 4\",\n              \"Vostok 1\"\n            ],\n            \"correctAnswer\": 0\n          },\n          {\n            \"question\": \"¿Cuál es el nombre del cuerpo celeste que orbita la Tierra?\",\n            \"answers\": [\n              \"Luna\",\n              \"Planeta\",\n              \"Cometa\",\n              \"Asteroide\"\n            ],\n            \"correctAnswer\": 0\n          }\n        ]\n      },\n      {\n        \"id\": 5,\n        \"title\": \"El Método Científico\",\n        \"description\": \"Aprende cómo los científicos investigan y descubren nuevos conocimientos a través del método científico.\",\n        \"content\": \"El método científico es una herramienta fundamental en la investigación y el descubrimiento de nuevos conocimientos. En esta etapa, exploraremos los pasos del método científico y cómo se aplican en la práctica.\\n\\nComenzaremos aprendiendo sobre la observación y la formulación de preguntas, entendiendo cómo los científicos identifican problemas y plantean hipótesis para resolverlos. Descubriremos la importancia de diseñar experimentos controlados para probar nuestras hipótesis y recopilar datos.\\n\\nAdemás, exploraremos cómo se analizan los datos y se llega a conclusiones basadas en la evidencia recopilada. Aprenderemos sobre la importancia de la revisión por pares y la comunicación de resultados en la comunidad científica.\\n\\nAl final de esta etapa, comprenderás cómo los científicos investigan y descubren nuevos conocimientos y cómo puedes aplicar el método científico en tu propia vida para resolver problemas y hacer descubrimientos.\",\n        \"completed\": false,\n        \"testScore\": 0,\n        \"questions\": [\n          {\n            \"question\": \"¿Cuál es el primer paso del método científico?\",\n            \"answers\": [\n              \"Formular una hipótesis\",\n              \"Diseñar un experimento\",\n              \"Observar y hacer preguntas\",\n              \"Analizar los datos\"\n            ],\n            \"correctAnswer\": 2\n          },\n          {\n            \"question\": \"¿Qué papel juegan los experimentos en el método científico?\",\n            \"answers\": [\n              \"Probar la hipótesis\",\n              \"Recopilar datos\",\n              \"Formular preguntas\",\n              \"Comunicar resultados\"\n            ],\n            \"correctAnswer\": 0\n          },\n          {\n            \"question\": \"¿Por qué es importante la revisión por pares en la investigación científica?\",\n            \"answers\": [\n              \"Para verificar la validez de los resultados\",\n              \"Para publicar en revistas científicas\",\n              \"Para obtener financiamiento\",\n              \"Para competir con otros científicos\"\n            ],\n            \"correctAnswer\": 0\n          },\n          {\n            \"question\": \"¿Qué paso del método científico implica sacar conclusiones basadas en los datos recopilados?\",\n            \"answers\": [\n              \"Formular una hipótesis\",\n              \"Diseñar un experimento\",\n              \"Observar y hacer preguntas\",\n              \"Analizar los datos\"\n            ],\n            \"correctAnswer\": 3\n          },\n          {\n            \"question\": \"¿Qué se hace después de comunicar los resultados en el método científico?\",\n            \"answers\": [\n              \"Diseñar un experimento nuevo\",\n              \"Realizar más observaciones\",\n              \"Revisar por pares\",\n              \"Formular nuevas preguntas\"\n            ],\n            \"correctAnswer\": 3\n          }\n        ]\n      }\n    ]\n  }\n\ndon't write "
            },
            {
                "role": "user",
                "content": prompt
            }
        ],
        "model": "llama3-70b-8192",
        "temperature": 1,
        "max_tokens": 4520,
        "top_p": 1,
        "stream": false,
        "stop": null
    });

    return chatCompletion.choices[0].message.content;
};

const generateCoursePrompt = (topic, experience, intensity) => {
    return `Generate course on ${topic} for ${experience} users with ${intensity} intensity. You must reply with a only JSON object with the exact same following format:`;
};

app.listen(port, () => {
    console.log(`Server running on http://localhost:${port}`);
});

module.exports = {
    generateCourse
};
